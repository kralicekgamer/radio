// Core player state
const playerState = {
    playlist: [],
    currentTrackIndex: 0,
    isPlaying: false,
    isShuffled: false,
    shuffledIndices: [],
    shufflePosition: 0,
    player: null,
    isPlayerReady: false
};

// DOM element cache for better performance
const elements = {
    playPauseBtn: null,
    songTitle: null,
    channelName: null,
    volumeSlider: null,
    volumeValue: null,
    shuffleBtn: null
};

// Constants
const YOUTUBE_API_URL = 'https://www.youtube.com/iframe_api';
const DEFAULT_VOLUME = 50;
const PLAYLIST_FILE = 'music.yaml';

/**
 * Console Logger with beautiful formatting
 */
const Logger = {
    colors: {
        primary: '#3498db',
        success: '#2ecc71',
        warning: '#f39c12',
        error: '#e74c3c',
        info: '#9b59b6',
        muted: '#7f8c8d'
    },

    /**
     * Display app header with ASCII art
     */
    displayHeader() {
        console.clear();

        this.info('üöÄ Application is starting...'); // Original: 'üöÄ Aplikace se spou≈°t√≠...'
        this.info('üì± This is the developer console - you will see all system messages here'); // Original: 'üì± Toto je konzole pro v√Ωvoj√°≈ôe - zde uvid√≠te v≈°echny syst√©mov√© zpr√°vy'
        this.separator();
    },

    /**
     * Log success message
     */
    success(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%c[${timestamp}] ‚úÖ ${message}`, `color: ${this.colors.success}; font-weight: bold`);
        if (data) {
            console.log(`%c‚îî‚îÄ Data:`, `color: ${this.colors.muted}`, data);
        }
    },

    /**
     * Log info message
     */
    info(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%c[${timestamp}] ‚ÑπÔ∏è  ${message}`, `color: ${this.colors.info}; font-weight: bold`);
        if (data) {
            console.log(`%c‚îî‚îÄ Data:`, `color: ${this.colors.muted}`, data);
        }
    },

    /**
     * Log warning message
     */
    warning(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%c[${timestamp}] ‚ö†Ô∏è  ${message}`, `color: ${this.colors.warning}; font-weight: bold`);
        if (data) {
            console.log(`%c‚îî‚îÄ Data:`, `color: ${this.colors.muted}`, data);
        }
    },

    /**
     * Log error message
     */
    error(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%c[${timestamp}] ‚ùå ${message}`, `color: ${this.colors.error}; font-weight: bold`);
        if (data) {
            console.log(`%c‚îî‚îÄ Error:`, `color: ${this.colors.muted}`, data);
        }
    },

    /**
     * Log track information
     */
    track(action, track) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%c[${timestamp}] üéµ ${action}`, `color: ${this.colors.primary}; font-weight: bold`);
        console.log(`%c‚îú‚îÄ Title: ${track.title}`, `color: ${this.colors.muted}`); // Original: '‚îú‚îÄ N√°zev: ${track.title}'
        console.log(`%c‚îú‚îÄ Channel: ${track.channel}`, `color: ${this.colors.muted}`); // Original: '‚îú‚îÄ Kan√°l: ${track.channel}'
        console.log(`%c‚îî‚îÄ URL: ${track.url}`, `color: ${this.colors.muted}`);
    },

    /**
     * Log playlist information
     */
    playlist(action, count, details = null) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%c[${timestamp}] üìã ${action} (${count} tracks)`, `color: ${this.colors.primary}; font-weight: bold`); // Original: 'Playlist naƒçten (${count} skladeb)'
        if (details) {
            console.log(`%c‚îî‚îÄ Detail:`, `color: ${this.colors.muted}`, details);
        }
    },

    /**
     * Log player state changes
     */
    playerState(state, details = null) {
        const timestamp = new Date().toLocaleTimeString();
        const stateEmojis = {
            'PLAYING': '‚ñ∂Ô∏è',
            'PAUSED': '‚è∏Ô∏è',
            'STOPPED': '‚èπÔ∏è',
            'ENDED': 'üîö',
            'READY': '‚úÖ',
            'LOADING': '‚è≥',
            'ERROR': '‚ùå'
        };

        const emoji = stateEmojis[state] || 'üîÑ';
        console.log(`%c[${timestamp}] ${emoji} Player: ${state}`, `color: ${this.colors.primary}; font-weight: bold`);
        if (details) {
            console.log(`%c‚îî‚îÄ Detail:`, `color: ${this.colors.muted}`, details);
        }
    },

    /**
     * Log shuffle information
     */
    shuffle(enabled, order = null) {
        const timestamp = new Date().toLocaleTimeString();
        const status = enabled ? 'ON' : 'OFF'; // Original: 'ZAPNUTO' : 'VYPNUTO'
        const emoji = enabled ? 'üîÄ' : 'üìã';
        console.log(`%c[${timestamp}] ${emoji} Shuffle: ${status}`, `color: ${this.colors.primary}; font-weight: bold`);
        if (order && enabled) {
            console.log(`%c‚îî‚îÄ New order:`, `color: ${this.colors.muted}`, order); // Original: '‚îî‚îÄ Nov√© po≈ôad√≠:'
        }
    },

    /**
     * Display separator
     */
    separator() {
        console.log('%c' + '‚îÄ'.repeat(120), `color: ${this.colors.muted}`);
    },

    /**
     * Display current status
     */
    status() {
        this.separator();
        console.log(`%cüìä CURRENT PLAYER STATUS`, `color: ${this.colors.primary}; font-weight: bold; font-size: 14px`); // Original: 'üìä AKTU√ÅLN√ç STAV P≈òEHR√ÅVAƒåE'
        console.log(`%c‚îú‚îÄ Playlist: ${playerState.playlist.length} tracks`, `color: ${this.colors.muted}`); // Original: '‚îú‚îÄ Playlist: ${playerState.playlist.length} skladeb'
        console.log(`%c‚îú‚îÄ Current index: ${playerState.currentTrackIndex + 1}/${playerState.playlist.length}`, `color: ${this.colors.muted}`); // Original: '‚îú‚îÄ Aktu√°ln√≠ index: ${playerState.currentTrackIndex + 1}/${playerState.playlist.length}'
        console.log(`%c‚îú‚îÄ Playing: ${playerState.isPlaying ? 'YES' : 'NO'}`, `color: ${this.colors.muted}`); // Original: '‚îú‚îÄ P≈ôehr√°v√°: ${playerState.isPlaying ? 'ANO' : 'NE'}'
        console.log(`%c‚îú‚îÄ Shuffle: ${playerState.isShuffled ? 'ON' : 'OFF'}`, `color: ${this.colors.muted}`); // Original: '‚îú‚îÄ Shuffle: ${playerState.isShuffled ? 'ZAPNUTO' : 'VYPNUTO'}'
        console.log(`%c‚îî‚îÄ API connected: ${playerState.isPlayerReady ? 'YES' : 'NO'}`, `color: ${this.colors.muted}`); // Original: '‚îî‚îÄ API p≈ôipojeno: ${playerState.isPlayerReady ? 'ANO' : 'NE'}'
        this.separator();
    }
};

/**
 * Initialize DOM elements cache
 */
function initializeElements() {
    Logger.info('üîß Initializing DOM elements...'); // Original: 'üîß Inicializuji DOM elementy...'

    elements.playPauseBtn = document.getElementById('playPauseBtn');
    elements.songTitle = document.getElementById('songTitle');
    elements.channelName = document.getElementById('channelName');
    elements.volumeSlider = document.getElementById('volumeSlider');
    elements.volumeValue = document.getElementById('volumeValue');
    elements.shuffleBtn = document.getElementById('shuffleBtn');

    const foundElements = Object.values(elements).filter(el => el !== null).length;
    Logger.success(`üéØ Found ${foundElements}/${Object.keys(elements).length} DOM elements`); // Original: 'üéØ Nalezeno ${foundElements}/${Object.keys(elements).length} DOM element≈Ø'
}

/**
 * YouTube API ready callback
 */
function onYouTubeIframeAPIReady() {
    Logger.info('üîå YouTube API is ready, creating player...'); // Original: 'üîå YouTube API je p≈ôipraven√©, vytv√°≈ô√≠m p≈ôehr√°vaƒç...'

    playerState.player = new YT.Player('youtube-player', {
        height: '0',
        width: '0',
        playerVars: {
            autoplay: 0,
            controls: 0,
            disablekb: 1,
            enablejsapi: 1,
            fs: 0,
            iv_load_policy: 3,
            modestbranding: 1,
            playsinline: 1,
            rel: 0
        },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
        }
    });

    Logger.success('üéÆ YouTube player has been created'); // Original: 'üéÆ YouTube p≈ôehr√°vaƒç byl vytvo≈ôen'
}

/**
 * Player ready event handler
 */
function onPlayerReady(event) {
    playerState.isPlayerReady = true;
    Logger.playerState('READY', `Default volume set to ${DEFAULT_VOLUME}%`); // Original: `V√Ωchoz√≠ hlasitost nastavena na ${DEFAULT_VOLUME}%`
    playerState.player.setVolume(DEFAULT_VOLUME);
    Logger.status();
}

/**
 * Player state change event handler
 */
function onPlayerStateChange(event) {
    const states = {
        [YT.PlayerState.ENDED]: 'ENDED',
        [YT.PlayerState.PLAYING]: 'PLAYING',
        [YT.PlayerState.PAUSED]: 'PAUSED',
        [YT.PlayerState.BUFFERING]: 'LOADING',
        [YT.PlayerState.CUED]: 'READY'
    };

    const currentState = states[event.data] || 'UNKNOWN';

    switch (event.data) {
        case YT.PlayerState.ENDED:
            Logger.playerState('ENDED', 'Moving to the next track'); // Original: 'P≈ôech√°z√≠m na dal≈°√≠ skladbu'
            nextTrack();
            break;
        case YT.PlayerState.PLAYING:
            Logger.playerState('PLAYING');
            updatePlayButton(true);
            break;
        case YT.PlayerState.PAUSED:
            Logger.playerState('PAUSED');
            updatePlayButton(false);
            break;
        case YT.PlayerState.BUFFERING:
            Logger.playerState('LOADING', 'Loading video data...'); // Original: 'Naƒç√≠t√°m video data...'
            break;
    }
}

/**
 * Player error event handler
 */
function onPlayerError(event) {
    const errorMessages = {
        2: 'Invalid video ID', // Original: 'Neplatn√© video ID'
        5: 'HTML5 player cannot play the video', // Original: 'HTML5 p≈ôehr√°vaƒç nedok√°≈æe p≈ôehr√°t video'
        100: 'Video not found', // Original: 'Video nebylo nalezeno'
        101: 'Video owner has forbidden playback in embedded player', // Original: 'Majitel videa zak√°zal p≈ôehr√°v√°n√≠ v embedded p≈ôehr√°vaƒçi'
        150: 'Video owner has forbidden playback in embedded player' // Original: 'Majitel videa zak√°zal p≈ôehr√°v√°n√≠ v embedded p≈ôehr√°vaƒçi'
    };

    const errorMsg = errorMessages[event.data] || `Unknown error (${event.data})`; // Original: `Nezn√°m√° chyba (${event.data})`
    Logger.error(`Youtubeer: ${errorMsg}`);
    Logger.info('‚è≠Ô∏è Skipping to the next track...'); // Original: '‚è≠Ô∏è P≈ôeskakuji na dal≈°√≠ skladbu...'
    nextTrack();
}

/**
 * Update play/pause button state
 */
function updatePlayButton(isPlaying) {
    playerState.isPlaying = isPlaying;
    if (elements.playPauseBtn) {
        elements.playPauseBtn.innerHTML = isPlaying
            ? '<i class="fa-solid fa-pause"></i>'
            : '<i class="fa-solid fa-play"></i>';
    }
}

/**
 * Load YouTube API script
 */
function loadYouTubeAPI() {
    Logger.info('üì° Loading YouTube API...'); // Original: 'üì° Naƒç√≠t√°m YouTube API...'

    const tag = document.createElement('script');
    tag.src = YOUTUBE_API_URL;
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    Logger.success('‚úÖ YouTube API script has been added to the page'); // Original: '‚úÖ YouTube API script byl p≈ôid√°n do str√°nky'
}

/**
 * Load playlist from YAML file
 */
async function loadPlaylist() {
    Logger.info(`üìÅ Loading playlist from file: ${PLAYLIST_FILE}`); // Original: `üìÅ Naƒç√≠t√°m playlist ze souboru: ${PLAYLIST_FILE}`

    try {
        const response = await fetch(PLAYLIST_FILE);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const yamlText = await response.text();
        const data = jsyaml.load(yamlText);

        if (!data?.playlist || !Array.isArray(data.playlist)) {
            throw new Error('Invalid YAML format - playlist array not found'); // Original: 'Neplatn√Ω form√°t YAML - playlist array nebyl nalezen'
        }

        playerState.playlist = data.playlist;
        initializeShuffleIndices();

        Logger.playlist('Playlist loaded', playerState.playlist.length, { // Original: 'Playlist naƒçten'
            'First track': playerState.playlist[0]?.title || 'N/A', // Original: 'Prvn√≠ skladba'
            'Last track': playerState.playlist[playerState.playlist.length - 1]?.title || 'N/A' // Original: 'Posledn√≠ skladba'
        });

        if (playerState.playlist.length > 0) {
            updateTrackInfo();
        }

        Logger.status();
    } catch (error) {
        Logger.error('Error loading playlist', error); // Original: 'Chyba p≈ôi naƒç√≠t√°n√≠ playlistu'
    }
}

/**
 * Initialize shuffle indices array
 */
function initializeShuffleIndices() {
    playerState.shuffledIndices = Array.from({ length: playerState.playlist.length }, (_, i) => i);
    playerState.shufflePosition = 0;
    Logger.info('üî¢ Initializing shuffle indices', playerState.shuffledIndices); // Original: 'üî¢ Inicializuji shuffle indexy'
}

/**
 * Shuffle array using Fisher-Yates algorithm
 */
function shuffleIndices() {
    const indices = playerState.shuffledIndices;
    for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    Logger.info('üé≤ Playlist was shuffled using the Fisher-Yates algorithm'); // Original: 'üé≤ Playlist byl zam√≠ch√°n pomoc√≠ Fisher-Yates algoritmu'
}

/**
 * Setup volume control slider
 */
function setupVolumeControl() {
    if (!elements.volumeSlider || !elements.volumeValue) {
        Logger.warning('üîä Volume controls were not found in DOM'); // Original: 'üîä Volume kontroly nebyly nalezeny v DOM'
        return;
    }

    Logger.info('üîä Setting up volume control...'); // Original: 'üîä Nastavuji ovl√°d√°n√≠ hlasitosti...'

    elements.volumeSlider.addEventListener('input', (event) => {
        const volume = parseInt(event.target.value);
        elements.volumeValue.textContent = volume;

        if (playerState.isPlayerReady) {
            playerState.player.setVolume(volume);
            Logger.info(`üîä Volume changed to ${volume}%`); // Original: `üîä Hlasitost zmƒõnƒõna na ${volume}%`
        }
    });

    // Set initial volume display
    elements.volumeValue.textContent = DEFAULT_VOLUME;
    Logger.success('üîä Volume control has been set up'); // Original: 'üîä Ovl√°d√°n√≠ hlasitosti bylo nastaveno'
}

/**
 * Play specific track by index
 */
function playTrack(index) {
    if (index < 0 || index >= playerState.playlist.length) {
        Logger.error(`‚ùå Invalid track index: ${index}`); // Original: `‚ùå Neplatn√Ω index skladby: ${index}`
        return;
    }

    playerState.currentTrackIndex = index;

    // Update shuffle position if shuffle is enabled
    if (playerState.isShuffled) {
        playerState.shufflePosition = playerState.shuffledIndices.indexOf(index);
    }

    updateTrackInfo();

    if (playerState.isPlayerReady) {
        const currentTrack = playerState.playlist[index];
        const videoId = extractVideoId(currentTrack.url);

        if (videoId) {
            playerState.player.loadVideoById(videoId);
            playerState.player.playVideo();
            Logger.track('Playing track', currentTrack); // Original: 'P≈ôehr√°v√°m skladbu'
        } else {
            Logger.error('Invalid video ID', currentTrack.url); // Original: 'Neplatn√© video ID'
            Logger.info('‚è≠Ô∏è Skipping to the next track...'); // Original: '‚è≠Ô∏è P≈ôeskakuji na dal≈°√≠ skladbu...'
            nextTrack();
        }
    } else {
        Logger.warning('‚è≥ Player is not ready yet'); // Original: '‚è≥ P≈ôehr√°vaƒç je≈°tƒõ nen√≠ p≈ôipraven'
    }
}

/**
 * Update track information display
 */
function updateTrackInfo() {
    const currentTrack = playerState.playlist[playerState.currentTrackIndex];
    if (!currentTrack) {
        Logger.warning('‚ùå Current track not found'); // Original: '‚ùå Aktu√°ln√≠ skladba nebyla nalezena'
        return;
    }

    if (elements.songTitle) {
        elements.songTitle.textContent = currentTrack.title;
    }
    if (elements.channelName) {
        elements.channelName.textContent = currentTrack.channel;
    }

    Logger.info(`üéµ Current track: ${currentTrack.title} - ${currentTrack.channel}`); // Original: `üéµ Aktu√°ln√≠ skladba: ${currentTrack.title} - ${currentTrack.channel}`
}

/**
 * Extract video ID from YouTube URL
 */
function extractVideoId(url) {
    const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[7].length === 11) ? match[7] : null;
}

/**
 * Toggle play/pause state
 */
function togglePlayPause() {
    if (!playerState.isPlayerReady) {
        Logger.warning('‚è≥ Player is not ready yet'); // Original: '‚è≥ P≈ôehr√°vaƒç je≈°tƒõ nen√≠ p≈ôipraven'
        return;
    }

    if (playerState.isPlaying) {
        Logger.info('‚è∏Ô∏è Pausing playback'); // Original: '‚è∏Ô∏è Pozastavuji p≈ôehr√°v√°n√≠'
        playerState.player.pauseVideo();
    } else {
        // If no video is loaded, start playing current track
        if (playerState.player.getPlayerState() === -1) {
            Logger.info('‚ñ∂Ô∏è Starting current track'); // Original: '‚ñ∂Ô∏è Spou≈°t√≠m aktu√°ln√≠ skladbu'
            playTrack(playerState.currentTrackIndex);
        } else {
            Logger.info('‚ñ∂Ô∏è Resuming playback'); // Original: '‚ñ∂Ô∏è Obnovuji p≈ôehr√°v√°n√≠'
            playerState.player.playVideo();
        }
    }
}

/**
 * Play next track
 */
function nextTrack() {
    if (playerState.playlist.length === 0) {
        Logger.warning('üì≠ Playlist is empty'); // Original: 'üì≠ Playlist je pr√°zdn√Ω'
        return;
    }

    if (playerState.isShuffled) {
        playerState.shufflePosition = (playerState.shufflePosition + 1) % playerState.shuffledIndices.length;

        // Re-shuffle when we complete a cycle
        if (playerState.shufflePosition === 0) {
            shuffleIndices();
            Logger.info('üîÑ One cycle completed - playlist was re-shuffled'); // Original: 'üîÑ Dokonƒçen jeden cyklus - playlist byl znovu zam√≠ch√°n'
        }

        playerState.currentTrackIndex = playerState.shuffledIndices[playerState.shufflePosition];
    } else {
        playerState.currentTrackIndex = (playerState.currentTrackIndex + 1) % playerState.playlist.length;
    }

    Logger.info(`‚è≠Ô∏è Moving to the next track (${playerState.currentTrackIndex + 1}/${playerState.playlist.length})`); // Original: `‚è≠Ô∏è P≈ôech√°z√≠m na dal≈°√≠ skladbu (${playerState.currentTrackIndex + 1}/${playerState.playlist.length})`
    playTrack(playerState.currentTrackIndex);
}

/**
 * Play previous track
 */
function previousTrack() {
    if (playerState.playlist.length === 0) {
        Logger.warning('üì≠ Playlist is empty'); // Original: 'üì≠ Playlist je pr√°zdn√Ω'
        return;
    }

    if (playerState.isShuffled) {
        playerState.shufflePosition = playerState.shufflePosition === 0
            ? playerState.shuffledIndices.length - 1
            : playerState.shufflePosition - 1;
        playerState.currentTrackIndex = playerState.shuffledIndices[playerState.shufflePosition];
    } else {
        playerState.currentTrackIndex = playerState.currentTrackIndex === 0
            ? playerState.playlist.length - 1
            : playerState.currentTrackIndex - 1;
    }

    Logger.info(`‚èÆÔ∏è Moving to the previous track (${playerState.currentTrackIndex + 1}/${playerState.playlist.length})`); // Original: `‚èÆÔ∏è P≈ôech√°z√≠m na p≈ôedchoz√≠ skladbu (${playerState.currentTrackIndex + 1}/${playerState.playlist.length})`
    playTrack(playerState.currentTrackIndex);
}

/**
 * Toggle shuffle mode
 */
function toggleShuffle() {
    playerState.isShuffled = !playerState.isShuffled;

    if (!elements.shuffleBtn) {
        Logger.warning('üîÄ Shuffle button not found'); // Original: 'üîÄ Shuffle tlaƒç√≠tko nebylo nalezeno'
        return;
    }

    if (playerState.isShuffled) {
        // Enable shuffle
        shuffleIndices();
        playerState.shufflePosition = playerState.shuffledIndices.indexOf(playerState.currentTrackIndex);

        elements.shuffleBtn.textContent = 'üîÄ Shuffle ON';
        elements.shuffleBtn.style.background = 'rgba(0, 255, 0, 0.3)';

        Logger.shuffle(true, playerState.shuffledIndices);
    } else {
        // Disable shuffle
        elements.shuffleBtn.textContent = 'üîÄ Shuffle';
        elements.shuffleBtn.style.background = 'rgba(255, 255, 255, 0.2)';

        Logger.shuffle(false);
    }

    updateTrackInfo();
}

/**
 * Initialize the music player
 */
function initializePlayer() {
    Logger.displayHeader();

    Logger.info('üöÄ Starting player initialization...'); // Original: 'üöÄ Spou≈°t√≠m inicializaci p≈ôehr√°vaƒçe...'

    initializeElements();
    loadYouTubeAPI();
    loadPlaylist();
    setupVolumeControl();

    Logger.success('‚úÖ Initialization completed!'); // Original: '‚úÖ Inicializace dokonƒçena!'
}

// Initialize player when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePlayer);
} else {
    initializePlayer();
}